function getGasStations(){var e=[],a=map.getBounds(),t=a.f.f+","+a.f.b,r=a.b.b+","+a.b.f,o={fields:"gasStationID,gasStationLat,gasStationLong,fuelCompNormalName,gasStationAddress,fuelCompID,phone1,gasStationOwner",gasStationLat_BETWEEN:t,gasStationLong_BETWEEN:r};$.ajax({type:"GET",url:api_url+"gasstations/",data:o,success:function(a){$("#gasStationsNumber").text(a.length);var t=new google.maps.InfoWindow;$.each(a,function(a,r){e.push(r.gasStationID);var o=new google.maps.LatLng(r.gasStationLat,r.gasStationLong),n=createMarket(o,r.gasStationAddress,r.fuelCompID);markers.push(n),n.addListener("click",function(){populateInfoWindow(this,t,r)})}),gasStationIDs=e,getPriceDataAnalytics()}})}function getPriceDataAnalytics(){if(gasStationIDs.length<=0)return $("#minPrice").text("0"),$("#avgPrice").text("0"),void $("#maxPrice").text("0");var e={gasStationID:gasStationIDs,max:"fuelPrice",min:"fuelPrice",avg:"fuelPrice",fuelTypeID:defaultFuelTypeID};$.ajax({type:"GET",url:api_url+"pricedata/",data:e,success:function(e){$("#minPrice").text(parseFloat(e[0].min_fuelPrice).toFixed(3)),$("#avgPrice").text(parseFloat(e[0].avg_fuelPrice).toFixed(3)),$("#maxPrice").text(parseFloat(e[0].max_fuelPrice).toFixed(3))}})}function loginSubmit(){$("#loginSubmit").click(function(e){e.preventDefault(),$("#loginError").empty(),$(".help-block").remove(),$(".has-error").removeClass("has-error"),$.ajax({type:"POST",url:api_url+"login/",data:$("#loginForm").serialize(),success:function(e){api_token=e.api_token,username=$("#loginUsername").val(),getOrders(),getUserGasStation(),showLogout(),$("#signInUpModal").modal("hide"),$.notify({message:e.message},{type:"success",placement:{from:"top",align:"center"}})},error:function(e){$("#loginError").append(e.responseJSON.message),$.each(e.responseJSON,function(e,a){$("#loginForm input[name="+e+"]").after('<span class="help-block">'+a+"</span>").parent("div").addClass("has-error")})}})})}function registerSubmit(){$("#registerSubmit").click(function(e){e.preventDefault(),$(".help-block").remove(),$("#registerError").empty(),$(".has-error").removeClass("has-error"),$.ajax({type:"POST",url:api_url+"register/",data:$("#registerForm").serialize(),success:function(e){api_token=e.api_token,username=$("#registerUsername").val(),$("#signInUpModal").modal("hide"),getOrders(),getUserGasStation(),showLogout(),$.notify({message:e.message},{type:"success",placement:{from:"top",align:"center"}})},error:function(e){$("#registerError").append(e.responseJSON.message),$.each(e.responseJSON,function(e,a){$("#registerForm input[name="+e+"]").after('<span class="help-block">'+a+"</span>").parent("div").addClass("has-error")})}})})}function getOrders(){$.ajax({type:"GET",url:api_url+"orders/",data:{api_token:api_token,owner:username},success:function(e){$("#ordersList").show(),$("#ordersNumber").append(e.length),$.each(e,function(e,a){var t=e+1;$("#ordersTable").append('<tr><th scope="row">'+t+"</th><td> "+a.client+" </td><td> "+a.fuelName+" </td><td> "+a.fuelPrice+" </td><td> "+a.quantity+" </td><td> "+a.create_time+" </td></tr>")})}})}function getUserGasStation(){$.ajax({type:"GET",url:api_url+"gasstations/",data:{fields:"gasStationID",username:username},success:function(e){jQuery.isEmptyObject(e)||($("#updateFuelData").show(),userGasStation=e[0].gasStationID)}})}function updatePriceDataSubmit(){$("#updatePriceDataSubmit").click(function(e){e.preventDefault(),$(".help-block").remove(),$("#updatePriceDataError").empty(),$(".has-error").removeClass("has-error"),$.ajax({type:"PUT",url:api_url+"pricedata/"+$("#updatePriceDataID").val(),data:{fuelPrice:$("#updateFuelPrice").val(),api_token:api_token},success:function(e){$("#updatePriceDataModal").modal("hide"),$.notify({message:e.message},{type:"success",placement:{from:"top",align:"center"}})},error:function(e){$("#updatePriceDataError").append(e.responseJSON.message),$.each(e.responseJSON,function(e,a){$("#updatePriceDataForm input[name="+e+"]").after('<span class="help-block">'+a+"</span>").parent("div").addClass("has-error")})}})})}function makeOrderSubmit(){$("#makeOrderSubmit").click(function(e){e.preventDefault(),$("#makeOrderError").empty(),$(".help-block").remove(),$(".has-error").removeClass("has-error"),$.ajax({type:"POST",url:api_url+"orders",data:$("#makeOrderForm").serialize()+"&api_token="+api_token,success:function(e){$("#makeOrderModal").modal("hide"),$.notify({message:e.message},{type:"success",placement:{from:"top",align:"center"}})},error:function(e){$("#makeOrderError").append(e.responseJSON.message),$.each(e.responseJSON,function(e,a){$("#makeOrderForm input[name="+e+"]").after('<span class="help-block">'+a+"</span>").parent("div").addClass("has-error")})}})})}function logout(){$("#signOut").click(function(){$.notify({message:"Successfully log out"},{type:"success",placement:{from:"top",align:"center"}}),$("#signInUp").show(),$("#signOut").hide(),$("#ordersList").hide(),$("#updateFuelData").hide(),$("#loginForm")[0].reset(),$("#registerForm")[0].reset(),$("#ordersTable > tbody").children().remove(),$("#ordersNumber").html(""),api_token="",username="",userGasStation=""})}function showLogout(){$("#signInUp").hide(),$("#signOut").show()}function settingsSubmit(){$("#fuelTypeForm").submit(function(e){e.preventDefault(),defaultFuelTypeID=$("#fuelTypeSelect").val(),defaultFuelTypeName=$("#fuelTypeSelect option:selected").text(),getPriceDataAnalytics(),$("#settingsModal").modal("hide")})}function drawFuelTypesChart(){var e={fields:"fuelNormalName",count:"priceDataID",groupby:"fuelNormalName",gasStationID:gasStationIDs},a=[["Task","Hours per Day"]];$.ajax({async:!1,type:"GET",url:api_url+"pricedata/",data:e,success:function(e){$.each(e,function(e,t){var r=[t.fuelNormalName,t.count_priceDataID];a.push(r)})}});var t=google.visualization.arrayToDataTable(a),r={title:"Fuel types per Gas stations"},o=new google.visualization.PieChart(document.getElementById("piechart"));o.draw(t,r)}function drawDefaultFuelPriceChart(){var e={fields:"fuelPrice",fuelTypeID:defaultFuelTypeID,gasStationID:gasStationIDs},a=[["Fuels",defaultFuelTypeName]];$.ajax({async:!1,type:"GET",url:api_url+"pricedata/",data:e,success:function(e){$.each(e,function(e,t){var r=[e+1,parseFloat(t.fuelPrice)];a.push(r)})}});var t=google.visualization.arrayToDataTable(a),r={title:"Fuel Price",curveType:"function",legend:{position:"bottom"}},o=new google.visualization.LineChart(document.getElementById("curve_chart"));o.draw(t,r)}function initMap(){var e=new google.maps.LatLng(37.840834994646166,23.74952344409178);map=new google.maps.Map(document.getElementById("map"),{center:e,zoom:6,mapTypeControl:!1}),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){var a={lat:e.coords.latitude,lng:e.coords.longitude};map.setCenter(a),map.setZoom(14)},function(){handleLocationError(!0)}):handleLocationError(!1),map.addListener("idle",function(){cleanMarkers(),getGasStations()})}function createMarket(e,a,t){var r=new google.maps.Marker({map:map,position:e,title:a,icon:"/img/gas_logos/"+t+".png"});return r}function handleLocationError(e){var a="Your browser doesn't support geolocation.";e&&(a="The Geolocation service failed."),$.notify({message:a},{type:"warning",placement:{from:"top",align:"center"}})}function populateInfoWindow(e,a,t){if(a.marker!=e){a.marker=e;var r=t.phone1;null==r&&(r="");var o='<img src="/img/gas_logos/'+t.fuelCompID+'.png" class="img-responsive" alt="'+t.fuelCompNormalName+'">',n='<button type="button" class="btn btn-primary" data-gasstationid="'+t.gasStationID+'" data-toggle="modal" data-target="#priceDataModal" data-action="order">Price Data</button>',i='<ul class="list-group"><li>'+o+"<h4>"+t.fuelCompNormalName+"</h4></li><li>"+t.gasStationOwner+"</li><li>"+t.gasStationAddress+"</li><li>"+r+"</li><li>"+n+"</li></ul>";a.setContent(i),a.open(map,e),a.addListener("closeclick",function(){a.setMarker(null)})}}function cleanMarkers(){for(var e=0;e<markers.length;e++)markers[e].setMap(null);markers=[]}function zoomToArea(){var e=new google.maps.Geocoder,a=document.getElementById("zoom-to-area-text").value;""==a?$.notify({message:"You must enter an area, or address."},{type:"danger",placement:{from:"top",align:"center"}}):e.geocode({address:a},function(e,a){a==google.maps.GeocoderStatus.OK?(map.setCenter(e[0].geometry.location),map.setZoom(14)):$.notify({message:"We could not find that location - try entering a more specific place."},{type:"danger",placement:{from:"top",align:"center"}})})}var api_token="",username="",userGasStation="",defaultFuelTypeID="1",defaultFuelTypeName="Αμόλυβδη 95",gasStationIDs=[],api_url="https://fuel.local/api/v1/";$(document).ready(function(){loginSubmit(),registerSubmit(),logout(),updatePriceDataSubmit(),makeOrderSubmit(),settingsSubmit()}),$(".nav-tabs a").on("shown.bs.tab",function(e){$(e.target).text(),$(e.relatedTarget).addClass("inactiveTab")}),$("#priceDataModal").on("show.bs.modal",function(e){var a=$(e.relatedTarget),t=a.data("action"),r="",o="";if("edit"==t){if(""===userGasStation)return;r=userGasStation,o="#updatePriceDataModal"}else r=a.data("gasstationid"),o="#makeOrderModal";$("#priceDataTable > tbody").children().remove(),$.ajax({async:!1,type:"GET",url:api_url+"gasstations/"+r+"/pricedata/",data:{fields:"priceDataID,fuelNormalName,fuelName,fuelPrice,dateUpdated,isPremium"},success:function(e){$.each(e,function(e,a){var r="Yes";0==a.isPremium&&(r="No"),$("#priceDataTable").append("<tr><td>"+a.fuelNormalName+"</td><td>"+a.fuelName+"</td><td>"+a.fuelPrice+"</td><td>"+a.dateUpdated+"</td><td>"+r+'</td><td><button type="button" class="btn btn-primary" data-toggle="modal" data-target="'+o+'" data-whatever="'+a.fuelName+","+a.priceDataID+","+a.fuelPrice+'">'+t+"</button></td></tr>")})}})}),$("#updatePriceDataModal").on("show.bs.modal",function(e){$("#priceDataModal").modal("hide");var a=$(e.relatedTarget),t=a.data("whatever"),r=t.split(","),o=$(this);o.find(".modal-title").text("Fuel: "+r[0]),o.find("#updatePriceDataID").val(r[1]),o.find("#updateFuelPrice").val(r[2])}),$("#makeOrderModal").on("show.bs.modal",function(e){""===api_token&&(e.preventDefault(),$.notify({message:"Please login or register to order."},{type:"danger",placement:{from:"top",align:"center"}})),$("#priceDataModal").modal("hide");var a=$(e.relatedTarget),t=a.data("whatever"),r=t.split(","),o=$(this);o.find(".modal-title").text("Fuel: "+r[0]),o.find("#makeOrderPriceDataID").val(r[1]),o.find("#makeOrderFuelPrice").val(r[2])}),$("#statsModal").on("show.bs.modal",function(e){google.charts.load("current",{packages:["corechart"]}),google.charts.setOnLoadCallback(drawFuelTypesChart),google.charts.setOnLoadCallback(drawDefaultFuelPriceChart)});var map=null,markers=[];document.getElementById("zoom-to-area").addEventListener("click",function(){zoomToArea()}),$("#zoom-to-area-text").keypress(function(e){return 13==e.which?($("#zoom-to-area").click(),!1):void 0});